---
phase: "04"
plan: "02"
title: "CLI Subcommand Restructuring"
wave: 1
depends_on: []
skills_used:
  - python-testing-patterns
must_haves:
  - "`jarkdown export PROJ-123` works as explicit subcommand form"
  - "`jarkdown PROJ-123` still works via backward-compat shim (regex `^[A-Z]+-\\d+$` on sys.argv[1])"
  - "`jarkdown bulk PROJ-1 PROJ-2 PROJ-3` accepted by argparse with nargs='+' positional"
  - "`jarkdown query 'project = FOO AND status = Done'` accepted with --max-results and --batch-name flags"
  - "Parent parser shared flags (--output, --verbose, --include-fields, --exclude-fields, --refresh-fields) available to all subcommands via parents=[parent_parser]"
  - "`jarkdown setup` invokes interactive configuration flow"
  - "`pytest tests/test_cli.py` passes with updated subcommand tests"
---

## Objective

Restructure the CLI in `jarkdown.py` from a single positional `issue_key` argument to proper argparse subcommands: `export`, `bulk`, `query`, and `setup`. Preserve backward compatibility so bare `jarkdown PROJ-123` still works. The `bulk` and `query` subcommands are wired to stub handlers in this plan — actual implementation comes in Plan 04 (wave 2).

## Context

Read these files before starting:
- `@src/jarkdown/jarkdown.py` — current 303-line CLI; will be fully restructured
- `@tests/test_cli.py` — update ALL existing tests to use subcommand form
- `@.vbw-planning/phases/04-bulk-export-jql/04-CONTEXT.md` — binding CLI design decisions (subcommand names, flag names, compat shim, --batch-name, --concurrency)
- `@.vbw-planning/phases/04-bulk-export-jql/04-RESEARCH.md` — argparse parent parser pattern, default subcommand detection regex

Key design decisions from context:
- Subcommands: `export`, `bulk`, `query`, `setup`
- `jarkdown PROJ-123` → detect via `^[A-Z]+-\d+$` regex on sys.argv[1], inject `["export", sys.argv[1]]` before parse
- `export` is the canonical single-issue form: `jarkdown export PROJ-123`
- `bulk` takes `nargs='+'` positional `issue_keys` + `--max-results` + `--batch-name` + `--concurrency`
- `query` takes positional `jql` string + `--max-results` + `--batch-name` + `--concurrency`
- Parent parser carries shared flags: `--output/-o`, `--verbose/-v`, `--include-fields`, `--exclude-fields`, `--refresh-fields`
- `export_issue()` function stays; `bulk` and `query` call stub that prints "not yet implemented" with sys.exit(0) for now
- All CLI uses `asyncio.run()` at the boundary for `export` subcommand (JiraApiClient is now async from Plan 01)

Merge safety: This plan owns `jarkdown.py` and `tests/test_cli.py`. Plan 01 owns `jira_api_client.py`, `attachment_handler.py`, `pyproject.toml`, `tests/test_components.py`. Plan 03 creates new files only. No overlaps.

## Tasks

### Task 1: Create parent parser with shared flags

**Files:** `src/jarkdown/jarkdown.py`

Restructure the top of `main()` to create a parent parser pattern:

```python
def main():
    # Parent parser: shared flags, no help (add_help=False)
    parent_parser = argparse.ArgumentParser(add_help=False)
    parent_parser.add_argument("--output", "-o", help="Output directory (default: current directory)")
    parent_parser.add_argument("--verbose", "-v", action="store_true", help="Enable verbose logging")
    parent_parser.add_argument("--refresh-fields", action="store_true",
                               help="Force refresh of cached Jira field metadata")
    parent_parser.add_argument("--include-fields",
                               help="Comma-separated list of custom field names to include")
    parent_parser.add_argument("--exclude-fields",
                               help="Comma-separated list of custom field names to exclude")

    # Main parser
    parser = argparse.ArgumentParser(
        prog="jarkdown",
        description="Export Jira issues to Markdown with attachments",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""...""",
    )
    parser.add_argument("--version", action="version", version=get_version())
    subparsers = parser.add_subparsers(dest="command")
```

Add the backward-compat shim BEFORE `parser.parse_args()`:
```python
    import re
    _ISSUE_KEY_RE = re.compile(r"^[A-Z]+-\d+$")
    if len(sys.argv) > 1 and _ISSUE_KEY_RE.match(sys.argv[1]):
        sys.argv.insert(1, "export")  # inject subcommand
```

**Tests:** N/A for this subtask (verified through subsequent tasks).

**Commit:** `refactor(phase-04): add parent parser and subcommand scaffold to CLI`

---

### Task 2: Add `export` subcommand

**Files:** `src/jarkdown/jarkdown.py`

Add the `export` subcommand to the main parser:

```python
    export_parser = subparsers.add_parser(
        "export",
        help="Export a single Jira issue to Markdown",
        parents=[parent_parser],
    )
    export_parser.add_argument("issue_key", help="Jira issue key (e.g., PROJ-123)")
```

In the dispatch block after `args = parser.parse_args()`:

```python
    if args.command == "export":
        _handle_export(args)
    elif args.command == "bulk":
        _handle_bulk(args)
    elif args.command == "query":
        _handle_query(args)
    elif args.command == "setup":
        setup_configuration()
        sys.exit(0)
    else:
        parser.print_help()
        sys.exit(1)
```

Extract `_handle_export(args)` function:
- Loads dotenv, validates env vars (same logic as current main)
- Creates `JiraApiClient` (now async context manager)
- Calls `asyncio.run(_async_export(args))` where `_async_export` is an async function that does:
  ```python
  async def _async_export(args):
      async with JiraApiClient(domain, email, api_token) as client:
          await export_issue(client, args.issue_key, args.output, ...)
  ```
- Update `export_issue()` to be `async def export_issue(...)` — replaces sync with async calls to async client

**Tests:** Verified in Task 5.

**Commit:** `feat(phase-04): add export subcommand to CLI`

---

### Task 3: Add `bulk` subcommand (stub)

**Files:** `src/jarkdown/jarkdown.py`

Add `bulk` subcommand:

```python
    bulk_parser = subparsers.add_parser(
        "bulk",
        help="Export multiple Jira issues by key",
        parents=[parent_parser],
    )
    bulk_parser.add_argument(
        "issue_keys",
        nargs="+",
        help="One or more Jira issue keys (e.g., PROJ-1 PROJ-2 PROJ-3)",
    )
    bulk_parser.add_argument(
        "--max-results",
        type=int,
        default=None,
        help="Maximum number of issues to export",
    )
    bulk_parser.add_argument(
        "--batch-name",
        help="Optional name for output batch directory wrapper",
    )
    bulk_parser.add_argument(
        "--concurrency",
        type=int,
        default=3,
        help="Maximum concurrent exports (default: 3)",
    )
```

Implement `_handle_bulk(args)` as a stub:
```python
def _handle_bulk(args):
    print("bulk export: not yet implemented", file=sys.stderr)
    sys.exit(0)
```

This stub is intentional — Plan 04 (wave 2) replaces it with the real BulkExporter implementation.

**Tests:** Verified in Task 5.

**Commit:** `feat(phase-04): add bulk subcommand stub to CLI`

---

### Task 4: Add `query` subcommand (stub)

**Files:** `src/jarkdown/jarkdown.py`

Add `query` subcommand:

```python
    query_parser = subparsers.add_parser(
        "query",
        help="Export Jira issues matching a JQL query",
        parents=[parent_parser],
    )
    query_parser.add_argument(
        "jql",
        help="JQL query string (e.g., 'project = FOO AND status = Done')",
    )
    query_parser.add_argument(
        "--max-results",
        type=int,
        default=50,
        help="Maximum number of issues to export (default: 50)",
    )
    query_parser.add_argument(
        "--batch-name",
        help="Optional name for output batch directory wrapper",
    )
    query_parser.add_argument(
        "--concurrency",
        type=int,
        default=3,
        help="Maximum concurrent exports (default: 3)",
    )
```

Implement `_handle_query(args)` as a stub:
```python
def _handle_query(args):
    print("query export: not yet implemented", file=sys.stderr)
    sys.exit(0)
```

**Tests:** Verified in Task 5.

**Commit:** `feat(phase-04): add query subcommand stub to CLI`

---

### Task 5: Update tests/test_cli.py for subcommand structure

**Files:** `tests/test_cli.py`

Update ALL existing CLI tests to use subcommand form. Key changes:

1. Single-issue export tests: change `["PROJ-123"]` to `["export", "PROJ-123"]`
2. Add backward-compat tests: `["PROJ-123"]` (no subcommand) — verify it runs same as `["export", "PROJ-123"]`
3. Add tests for each new subcommand:
   - `test_bulk_subcommand_stub`: runs `["bulk", "PROJ-1", "PROJ-2"]` — currently exits 0 with "not yet implemented"
   - `test_query_subcommand_stub`: runs `["query", "project = FOO"]` — same
   - `test_setup_subcommand`: verify `["setup"]` invokes setup_configuration
4. Shared flag tests: verify `--output`, `--verbose`, `--include-fields` work under `export` subcommand
5. Error case: `jarkdown` with no args → help text + exit 1 (not an error, just no command)

Since `export_issue()` is now async and `_handle_export` calls `asyncio.run()`, existing in-process test patterns still work — the mock patches remain at the API client boundary.

Make sure all 187 existing tests still pass: run `pytest tests/ -v` and verify count.

**Tests:** This task IS the test update.

**Commit:** `test(phase-04): update test_cli.py for subcommand structure`

## Verification

```bash
pytest tests/test_cli.py -v
# Manual smoke (dry-run with mock env):
python -m jarkdown.jarkdown export --help
python -m jarkdown.jarkdown bulk --help
python -m jarkdown.jarkdown query --help
# Backward compat detection:
python -c "import sys; sys.argv = ['jarkdown', 'PROJ-123']; import re; print(bool(re.match(r'^[A-Z]+-\d+$', sys.argv[1])))"
```

## Success Criteria

- All four subcommands parseable by argparse: `export`, `bulk`, `query`, `setup`
- Backward-compat shim auto-detects `PROJ-123` pattern and routes to `export`
- Shared parent flags (--output, --verbose, etc.) work on all subcommands
- `bulk` and `query` accept their positional args without argparse errors
- `export` subcommand calls `asyncio.run()` and uses async JiraApiClient context manager
- All existing test scenarios preserved; updated for subcommand invocation style
- `pytest tests/test_cli.py` passes
