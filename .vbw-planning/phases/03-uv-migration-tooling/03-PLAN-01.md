---
phase: "03"
plan: "01"
title: "Build System Migration (setuptools → hatchling)"
wave: 1
depends_on: []
skills_used: []
must_haves:
  - "`[build-system]` in pyproject.toml uses `requires = [\"hatchling\"]` and `build-backend = \"hatchling.build\"`"
  - "`[tool.setuptools.packages.find]` section is removed from pyproject.toml"
  - "`[tool.hatch.build.targets.wheel]` has `packages = [\"src/jarkdown\"]` for src-layout discovery"
  - "MANIFEST.in file is deleted from the repository"
  - "uv.lock is tracked in git (committed, not in .gitignore)"
  - "`uv sync --locked` succeeds without errors"
  - "`uv build` produces both .whl and .tar.gz in dist/"
  - "`uv run pytest` passes all 187 existing tests"
---

## Objective

Migrate the Python build system from setuptools to hatchling and commit uv.lock for reproducible dependency resolution. This is the foundational change that all other phase 3 work builds on.

## Context

Read these files before starting:
- `@pyproject.toml` — current setuptools-based config, ONLY file to edit (build-system + package discovery sections)
- `@MANIFEST.in` — to be deleted (hatchling uses .gitignore patterns instead)
- `@.vbw-planning/phases/03-uv-migration-tooling/03-CONTEXT.md` — binding decisions
- `@.vbw-planning/phases/03-uv-migration-tooling/03-RESEARCH.md` — hatchling migration patterns

Key facts:
- src-layout: package is at `src/jarkdown/`
- Version is static: `version = "0.2.0"` in `[project]` table — keep as-is
- Conditional dep: `'tomli>=2.0.0;python_version<"3.11"'` — works unchanged with hatchling
- `[project]` table, `[project.urls]`, `[project.scripts]`, `[project.optional-dependencies]`, `[tool.pytest.*]`, `[tool.coverage.*]` sections are PEP 621 standard — no changes needed
- uv.lock already exists locally (216KB, untracked) but may need regeneration after build-system change

## Tasks

### Task 1: Migrate pyproject.toml build system to hatchling

**Files:** `pyproject.toml`

Replace the build-system section and add hatchling package discovery:

1. Replace `[build-system]`:
   ```toml
   [build-system]
   requires = ["hatchling"]
   build-backend = "hatchling.build"
   ```

2. Remove the entire `[tool.setuptools.packages.find]` section (lines 63-66):
   ```toml
   # DELETE THIS ENTIRE BLOCK:
   [tool.setuptools.packages.find]
   where = ["src"]
   include = ["jarkdown*"]
   exclude = ["tests*"]
   ```

3. Add hatchling src-layout config (after `[tool.coverage.report]` section, at end of file):
   ```toml
   [tool.hatch.build.targets.wheel]
   packages = ["src/jarkdown"]
   ```

**Do NOT change** any other sections (`[project]`, `[project.urls]`, `[project.scripts]`, `[project.optional-dependencies]`, `[tool.pytest.ini_options]`, `[tool.coverage.*]`).

**Acceptance:** `grep -c "hatchling" pyproject.toml` returns 2. `grep -c "setuptools" pyproject.toml` returns 0. `[tool.hatch.build.targets.wheel]` section exists.

**Commit:** `chore(build): migrate from setuptools to hatchling build backend`

### Task 2: Delete MANIFEST.in

**Files:** `MANIFEST.in` (delete)

Delete the file `MANIFEST.in` from the repository. Hatchling uses `.gitignore` patterns for source distribution inclusion — MANIFEST.in is a setuptools artifact that is no longer needed.

**Acceptance:** `MANIFEST.in` does not exist. `git status` shows it as deleted.

**Commit:** `chore(build): remove MANIFEST.in (hatchling uses gitignore patterns)`

### Task 3: Regenerate and commit uv.lock

**Files:** `uv.lock`

1. Run `uv lock` to regenerate uv.lock with the new hatchling build-system
2. Verify the lock file is valid: `uv sync --locked` must succeed
3. Verify the build works: `uv build` must produce both `.whl` and `.tar.gz` in `dist/`
4. Verify tests pass: `uv run pytest` must pass all tests
5. Stage and commit `uv.lock`

**Acceptance:** `uv sync --locked` exits 0. `ls dist/*.whl dist/*.tar.gz` shows both artifacts. `uv run pytest` reports 0 failures.

**Commit:** `chore(build): commit uv.lock for reproducible dependency resolution`

## Verification

```bash
# Build system is hatchling
grep "hatchling" pyproject.toml
# No setuptools references remain
grep "setuptools" pyproject.toml  # should return nothing
# MANIFEST.in is gone
test ! -f MANIFEST.in && echo "MANIFEST.in deleted"
# uv.lock is tracked
git ls-files uv.lock  # should show uv.lock
# Build produces artifacts
uv build && ls dist/
# All tests pass
uv run pytest -v
```

## Success Criteria

- pyproject.toml uses hatchling build backend with src-layout config
- No setuptools references remain in pyproject.toml
- MANIFEST.in is deleted
- uv.lock is committed to git
- `uv build` produces valid wheel and sdist
- All 187 existing tests pass via `uv run pytest`
