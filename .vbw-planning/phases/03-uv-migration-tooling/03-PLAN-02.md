---
phase: "03"
plan: "02"
title: "CI Workflow Migration to uv"
wave: 1
depends_on: []
skills_used: []
must_haves:
  - "ci.yml test job uses `astral-sh/setup-uv@v7` with `enable-cache: true` instead of setup-python + pip"
  - "ci.yml test job installs deps via `uv sync --locked --all-extras --dev` and runs tests via `uv run pytest`"
  - "ci.yml lint job uses `uvx ruff check` instead of pip-installed ruff"
  - "ci.yml docs job uses `uv sync --locked` and `uv pip install -r docs/requirements.txt` instead of pip"
  - "ci.yml has no remaining references to `pip install`, `setup-python`, or `actions/cache` for pip"
  - "publish-to-pypi.yml uses `astral-sh/setup-uv@v7` and `uv build` instead of setup-python + `python -m build`"
  - "publish-to-pypi.yml retains `pypa/gh-action-pypi-publish@release/v1` with `id-token: write` permission"
  - "No `setup-python` action remains in any workflow file"
---

## Objective

Replace all pip-based CI workflows with uv equivalents. Every job (test matrix, lint, docs, publish) switches to `astral-sh/setup-uv@v7` for Python/dependency management.

## Context

Read these files before starting:
- `@.github/workflows/ci.yml` — 4 jobs to migrate: test, lint, security, docs
- `@.github/workflows/publish-to-pypi.yml` — 1 job to migrate: publish
- `@.vbw-planning/phases/03-uv-migration-tooling/03-RESEARCH.md` — CI migration patterns
- `@.vbw-planning/phases/03-uv-migration-tooling/03-CONTEXT.md` — decisions on CI changes

Key patterns from research:
```yaml
# setup-uv replaces both setup-python AND actions/cache
- uses: astral-sh/setup-uv@v7
  with:
    enable-cache: true

# Install deps from lock file
- run: uv sync --locked --all-extras --dev

# Run commands through uv
- run: uv run pytest
```

For the lint job, use `uvx` (ephemeral tool runner) instead of installing ruff:
```yaml
- run: uvx ruff check . --select=E9,F63,F7,F82
```

The security job (Trivy) does NOT use Python/pip — leave it unchanged.

## Tasks

### Task 1: Migrate test job in ci.yml

**Files:** `.github/workflows/ci.yml`

Replace the `test` job steps:

**Before:**
```yaml
- uses: actions/setup-python@v4
  with:
    python-version: ${{ matrix.python-version }}
- uses: actions/cache@v3
  ...
- run: |
    python -m pip install --upgrade pip
    pip install .[dev]
- run: pytest --cov=...
```

**After:**
```yaml
- uses: actions/checkout@v4
- uses: astral-sh/setup-uv@v7
  with:
    enable-cache: true
    python-version: ${{ matrix.python-version }}
- run: uv sync --locked --all-extras --dev
- name: Run tests with coverage
  run: uv run pytest --cov=src/jarkdown --cov-report=term-missing --cov-report=xml
```

Note: `python-version` is passed to `setup-uv` (not `uv sync`) — the action installs the correct Python version. `uv sync` then uses it automatically.

Also update `actions/checkout@v3` → `actions/checkout@v4` in this job.

Remove the entire `Cache pip packages` step (uv handles its own caching via `enable-cache: true`).

**Acceptance:** Test job has no `setup-python`, no `actions/cache`, no `pip`. Uses `astral-sh/setup-uv@v7` and `uv sync`/`uv run`.

**Commit:** `chore(ci): migrate test job from pip to uv`

### Task 2: Migrate lint job in ci.yml

**Files:** `.github/workflows/ci.yml`

Replace the `lint` job steps:

**Before:**
```yaml
- uses: actions/setup-python@v4
  ...
- run: |
    python -m pip install --upgrade pip
    pip install ruff
- run: |
    ruff check . --select=E9,F63,F7,F82
    ruff check . --exit-zero || true
```

**After:**
```yaml
- uses: actions/checkout@v4
- uses: astral-sh/setup-uv@v7
  with:
    enable-cache: true
- name: Lint with ruff
  run: |
    uvx ruff check . --select=E9,F63,F7,F82
    uvx ruff check . --exit-zero || true
```

`uvx` runs ruff as an ephemeral tool — no separate install step needed.

Update `actions/checkout@v3` → `actions/checkout@v4`.

**Acceptance:** Lint job has no `setup-python`, no `pip install ruff`. Uses `uvx ruff check`.

**Commit:** `chore(ci): migrate lint job from pip to uv`

### Task 3: Migrate docs job in ci.yml

**Files:** `.github/workflows/ci.yml`

Replace the `docs` job steps:

**Before:**
```yaml
- uses: actions/setup-python@v4
  ...
- run: |
    python -m pip install --upgrade pip
    pip install -r docs/requirements.txt
    pip install -e .
- run: sphinx-build ...
```

**After:**
```yaml
- uses: actions/checkout@v4
- uses: astral-sh/setup-uv@v7
  with:
    enable-cache: true
- name: Install dependencies
  run: |
    uv sync --locked
    uv pip install -r docs/requirements.txt
- name: Build documentation
  run: uv run sphinx-build -b html docs/source docs/build/html --keep-going
- name: Check for broken links
  run: uv run sphinx-build -b linkcheck docs/source docs/build/linkcheck
```

`uv sync --locked` installs the project. `uv pip install` adds the docs deps into the same venv. `uv run` executes sphinx-build from the venv.

Update `actions/checkout@v3` → `actions/checkout@v4`. Also update the security job's `actions/checkout@v3` → `actions/checkout@v4` while touching this file (consistency).

**Acceptance:** Docs job has no `setup-python`, no `pip`. Uses `uv sync` + `uv pip install` + `uv run`.

**Commit:** `chore(ci): migrate docs job from pip to uv`

### Task 4: Migrate publish-to-pypi.yml

**Files:** `.github/workflows/publish-to-pypi.yml`

Replace the entire publish workflow:

**Before:**
```yaml
steps:
  - uses: actions/checkout@v4
  - uses: actions/setup-python@v4
    with:
      python-version: "3.11"
  - run: |
      python -m pip install --upgrade pip
      pip install build
  - run: python -m build
  - uses: pypa/gh-action-pypi-publish@release/v1
```

**After:**
```yaml
steps:
  - uses: actions/checkout@v4
  - uses: astral-sh/setup-uv@v7
    with:
      enable-cache: true
  - name: Build package
    run: uv build
  - name: Publish package to PyPI
    uses: pypa/gh-action-pypi-publish@release/v1
```

Keep `permissions: { id-token: write }` for trusted publishing (OIDC). Remove the comment about it being the first line.

**Acceptance:** Publish workflow has no `setup-python`, no `pip install build`, no `python -m build`. Uses `uv build`. Still uses `pypa/gh-action-pypi-publish@release/v1`.

**Commit:** `chore(ci): migrate publish workflow from pip to uv`

## Verification

```bash
# No pip references in CI
grep -r "pip install" .github/workflows/ && echo "FAIL: pip still referenced" || echo "PASS"
# No setup-python references
grep -r "setup-python" .github/workflows/ && echo "FAIL: setup-python still referenced" || echo "PASS"
# setup-uv present in all workflow files
grep -l "setup-uv" .github/workflows/ci.yml .github/workflows/publish-to-pypi.yml
# YAML is valid
python -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml')); print('ci.yml valid')"
python -c "import yaml; yaml.safe_load(open('.github/workflows/publish-to-pypi.yml')); print('publish valid')"
```

## Success Criteria

- All CI jobs use `astral-sh/setup-uv@v7` instead of `setup-python`
- No `pip install` commands remain in any workflow
- Test matrix uses `uv sync --locked` + `uv run pytest`
- Lint uses `uvx ruff check` (ephemeral tool)
- Docs uses `uv sync` + `uv pip install` for sphinx deps
- Publish uses `uv build` + existing PyPI publish action
- Trusted publishing (OIDC) preserved with `id-token: write`
- All checkout actions updated to v4
