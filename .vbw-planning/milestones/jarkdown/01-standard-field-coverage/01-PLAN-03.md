---
phase: "01"
plan: "03"
title: "Worklogs + Environment Body Sections"
wave: 1
depends_on: []
skills_used:
  - python-testing-patterns
must_haves:
  - "`_compose_worklogs_section()` method exists on MarkdownConverter"
  - "`_compose_environment_section()` method exists on MarkdownConverter"
  - "`_adf_to_plain_text()` helper method exists on MarkdownConverter"
  - "Worklogs rendered as markdown table: Author | Time Spent | Date | Comment"
  - "Total time logged summary above table using `**Total Time Logged:** Xd Xh Xm` format"
  - "Truncation warning when worklog `total > maxResults`"
  - "ADF worklog comments stripped to plain text for table cells"
  - "Environment uses `renderedFields.environment` HTML with ADF fallback"
  - "Empty worklogs section shows 'None'"
  - "Empty environment section shows 'None'"
  - "`pytest tests/test_sections_worklogs_env.py` passes"
---

## Objective

Add `_compose_worklogs_section()`, `_compose_environment_section()`, and `_adf_to_plain_text()` methods to MarkdownConverter for rendering worklogs and environment as markdown body sections.

## Context

Read these files before starting:
- `@src/jarkdown/markdown_converter.py` — add new methods AFTER `_parse_adf_to_markdown()` method (after line ~368, before `_compose_comments_section`). Do NOT modify any existing methods.
- `@.vbw-planning/phases/01-standard-field-coverage/01-CONTEXT.md` — binding rendering decisions (worklog table format, environment rendering)
- `@.vbw-planning/phases/01-standard-field-coverage/01-RESEARCH.md` — API structures for worklog and environment

Key API shapes (from research):
- `worklog`: `{"startAt": 0, "maxResults": 20, "total": N, "worklogs": [...]}`. Each entry: `author.displayName`, `started` (ISO datetime), `timeSpent` (human string), `timeSpentSeconds` (int), `comment` (ADF dict, string, or null).
- `environment`: ADF in `fields.environment`, HTML in `renderedFields.environment`. Can be null.

IMPORTANT — Merge safety: This plan runs in parallel with Plans 01 and 02 (same wave). Plan 01 modifies `_generate_metadata_dict()` (later in the file). Plan 02 inserts methods after `replace_attachment_links()` (earlier in the file). Your insertion point (after `_parse_adf_to_markdown`, before `_compose_comments_section`) is well-separated from both. Create test files with unique filenames.

## Tasks

### Task 1: Create test fixtures

Create `tests/data/issue_with_worklogs.json`:
- `key`: `"WORK-100"`, basic fields (summary, issuetype, status, reporter, created, updated)
- `worklog` object with:
  - `startAt: 0`, `maxResults: 20`, `total: 2`
  - `worklogs` array with 2 entries:
    1. author `"Alice Dev"`, started `"2025-03-10T09:00:00.000+0000"`, timeSpent `"3h 20m"`, timeSpentSeconds `12000`, comment as ADF: `{"type": "doc", "version": 1, "content": [{"type": "paragraph", "content": [{"type": "text", "text": "Fixed the login bug"}]}]}`
    2. author `"Bob Eng"`, started `"2025-03-11T14:00:00.000+0000"`, timeSpent `"1h"`, timeSpentSeconds `3600`, comment `null`
- `renderedFields.description`: simple HTML

Create `tests/data/issue_with_worklogs_truncated.json`:
- Same structure but `total: 32`, `maxResults: 20` — triggers truncation warning
- Only 2 worklogs in the array (simulating embedded subset)

Create `tests/data/issue_with_environment.json`:
- `key`: `"ENV-100"`, basic fields
- `renderedFields.environment`: `"<p>Production — Ubuntu 20.04, Java 11</p>"`
- `fields.environment`: ADF structure (same content as fallback): `{"type": "doc", "version": 1, "content": [{"type": "paragraph", "content": [{"type": "text", "text": "Production — Ubuntu 20.04, Java 11"}]}]}`
- `renderedFields.description`: simple HTML

Commit: `test(phase-01): add worklog and environment fixtures`

### Task 2: Implement _compose_environment_section

Add method to MarkdownConverter AFTER `_parse_adf_to_markdown()` method (before `_compose_comments_section`):

```python
def _compose_environment_section(self, issue_data):
    """Compose the environment section of the markdown.

    Args:
        issue_data: Raw issue data from Jira API

    Returns:
        list: Lines of markdown content for environment section
    """
```

Logic:
1. Start with `["## Environment", ""]`
2. Try `issue_data.get("renderedFields", {}).get("environment")` (HTML string) first:
   - If truthy: convert with `self.convert_html_to_markdown()`, append result
3. Else try `issue_data.get("fields", {}).get("environment")` (ADF dict):
   - If truthy and is a dict: convert with `self._parse_adf_to_markdown()`, append result
   - If truthy and is a string: append as-is
4. If neither produced content: append `"None"`
5. Append trailing `""`
6. Return lines

Commit: `feat(phase-01): add environment section renderer`

### Task 3: Implement _adf_to_plain_text and _compose_worklogs_section

Add both methods after `_compose_environment_section()`.

First, the plain-text ADF helper:
```python
def _adf_to_plain_text(self, adf_content):
    """Extract plain text from ADF content, stripping all formatting.

    Args:
        adf_content: ADF structure (dict), string, or None

    Returns:
        str: Plain text content
    """
```

Logic: Recursively walk the ADF tree. For `text` nodes, return `.text` value. For all other node types, recurse into `.content` children and join with spaces. Return empty string for None/non-dict input. If input is a plain string, return it directly.

Then the worklogs section:
```python
def _compose_worklogs_section(self, issue_data):
    """Compose the worklogs section of the markdown.

    Args:
        issue_data: Raw issue data from Jira API

    Returns:
        list: Lines of markdown content for worklogs section
    """
```

Logic:
1. Extract `fields.get("worklog") or {}` → get `worklogs` list, `total`, `maxResults`
2. Start with `["## Worklogs", ""]`
3. If no worklogs (empty list or missing): append `"None"`, trailing `""`, return
4. Calculate total time: sum `timeSpentSeconds` across all entries
5. Format total as human-readable: `Xd Xh Xm` (1 day = 8h = 28800s, omit zero components)
6. Append `**Total Time Logged:** {formatted_total}`
7. Append blank line
8. If `total > maxResults` (or `total > len(worklogs)`): append `> **Note:** Showing {len(worklogs)} of {total} worklogs. Additional worklogs may exist.` and blank line
9. Append table header: `| Author | Time Spent | Date | Comment |`
10. Append separator: `|--------|-----------|------|---------|`
11. For each worklog entry:
    - Author: `entry.get("author", {}).get("displayName", "Unknown")`
    - Time Spent: `entry.get("timeSpent", "")`
    - Date: parse `entry.get("started", "")` to `YYYY-MM-DD` (just take first 10 chars)
    - Comment: Use `self._adf_to_plain_text(entry.get("comment"))`. Replace `|` with `\|` for table safety. Use `""` if empty/null.
    - Append: `| {author} | {time_spent} | {date} | {comment} |`
12. Append trailing `""`
13. Return lines

Commit: `feat(phase-01): add worklogs section renderer with ADF plain-text helper`

### Task 4: Write tests

Create `tests/test_sections_worklogs_env.py` with its own fixtures:

```python
@pytest.fixture
def converter():
    return MarkdownConverter("https://example.atlassian.net", "example.atlassian.net")
```

**TestEnvironmentSection** class:
- `test_environment_html`: Issue with `renderedFields.environment` as HTML → verify markdown conversion output appears
- `test_environment_adf_fallback`: Issue with NO rendered HTML but `fields.environment` as ADF dict → verify ADF content extracted
- `test_environment_string_fallback`: Issue with `fields.environment` as plain string → verify string appears
- `test_environment_empty`: Both null → verify section shows "None"
- `test_environment_missing`: No environment key at all → verify "None"

**TestWorklogsSection** class:
- `test_worklogs_with_data`: Load `issue_with_worklogs.json`, verify:
  - Contains `## Worklogs`
  - Contains `**Total Time Logged:**` with calculated total
  - Contains table headers `| Author | Time Spent | Date | Comment |`
  - Contains row for Alice Dev with "3h 20m" and date "2025-03-10" and comment "Fixed the login bug"
  - Contains row for Bob Eng with "1h" and date "2025-03-11" and empty comment
- `test_worklogs_truncated`: Load truncated fixture, verify `> **Note:** Showing 2 of 32 worklogs` warning appears
- `test_worklogs_empty`: Issue with `"worklog": {"worklogs": [], "total": 0}` → "None"
- `test_worklogs_missing`: No worklog key → "None"
- `test_worklogs_null_comment`: Worklog entry with `"comment": null` → empty comment cell, no crash

**TestAdfToPlainText** class:
- `test_simple_text`: ADF doc with single paragraph → returns plain text
- `test_formatted_text`: ADF with bold/italic marks → returns text without formatting markers
- `test_nested_content`: ADF with list items → returns concatenated text
- `test_null_input`: `None` → empty string
- `test_string_input`: Plain string → returned as-is

Commit: `test(phase-01): add worklog and environment section tests`

## Verification

```bash
pytest tests/test_sections_worklogs_env.py -v
pytest tests/test_components.py -v  # existing tests unchanged
```

## Success Criteria

- Worklogs render as proper markdown table with correct columns
- Total time logged summary appears above table in human-readable format
- Truncation warning appears when embedded worklogs are incomplete
- ADF comments extracted as plain text for table cells (no markdown syntax)
- Environment section uses rendered HTML with ADF fallback
- Empty sections show "None"
- All tests pass
